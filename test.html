<html>
 <head>
 </head>
 <body>
  <script src="https://www.puck-js.com/puck.js"></script>
  
  <button id="connectButton">Connect!</button>
  
  <button onclick="Puck.write('LED1.set();\n');">On!</button>
  <button onclick="Puck.write('LED1.reset();\n');">Off!</button>

  <svg id="dial" viewBox="-100 -100 200 200"  width="100" height="100">
   <line id="line" x1="0" y1="0" x2="90" y2="0" style="stroke:rgb(255,0,0);stroke-width:2" />
  </svg>
  <p>Counter: <span id="counter"/></p>
 
  <script>        
   var counter=0;
   
    function onLine(v) {
      console.log("Received: "+JSON.stringify(v));
      counter = v;
      var r = 90;
      var theta = counter * (2*3.14159 / 1024);
      var x = r * Math.cos(theta);
      var y = r * Math.sin(theta);
      document.getElementById("line").setAttribute("x2",x);
      document.getElementById("line").setAttribute("y2",y);    
      document.getElementById("counter").innerHTML=counter;    
    }
   
   
   var connection;
   var cbutton = document.getElementById('connectButton');
    cbutton.addEventListener("click", function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }
      Puck.connect(function(c) {
        if (!c) {
          alert("Couldn't connect!");
          return;
        }
        connection = c;
        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var i = buf.indexOf("\n");
          while (i>=0) {
            onLine(buf.substr(0,i));
            buf = buf.substr(i+1);
            i = buf.indexOf("\n");
          }
        });
       /*
        // First, reset Puck.js
        connection.write("reset();\n", function() {
          // Wait for it to reset itself
          setTimeout(function() {
            // Now tell it to write data on the current light level to Bluetooth
            // 10 times a second. Also ensure that when disconnected, Puck.js
            // resets so the setInterval doesn't keep draining battery.
            connection.write("setInterval(function(){Bluetooth.println(Puck.light());},100);NRF.on('disconnect', function() {reset()});\n",
              function() { console.log("Ready..."); });
          }, 1500);
        });
        */
        
      });
    });
   
   /*
   var counter=0;
   setInterval(function() {
    Puck.eval("c.getEnc()",function(x) { counter = x; });
    var r = 90;
    var theta = counter * (2*3.14159 / 1024);
    var x = r * Math.cos(theta);
    var y = r * Math.sin(theta);
    document.getElementById("line").setAttribute("x2",x);
    document.getElementById("line").setAttribute("y2",y);    
    document.getElementById("counter").innerHTML=counter;    
   }, 16);
   */
   
  </script>
 </body>
</html>
