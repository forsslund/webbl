<html>
 <head>
 </head>
 <body>
  <script src="https://www.puck-js.com/puck.js"></script>
  
  <button id="connectButton">Connect!</button>
  
  <button onclick="Puck.write('LED1.set();\n');">On!</button>
  <button onclick="Puck.write('LED1.reset();\n');">Off!</button>

  <svg id="dial" viewBox="-100 -100 200 200"  width="100" height="100">
   <line id="line" x1="0" y1="0" x2="90" y2="0" style="stroke:rgb(255,0,0);stroke-width:2" />
  </svg>
  <p>Counter: <span id="counter"/></p>
 
  <script>        
   var counter=0;
   
    function onLine(v) {
      console.log("Received: "+JSON.stringify(v));
      counter = v;
      var r = 90;
      var theta = counter * (2*3.14159 / 1024);
      var x = r * Math.cos(theta);
      var y = r * Math.sin(theta);
      document.getElementById("line").setAttribute("x2",x);
      document.getElementById("line").setAttribute("y2",y);    
      document.getElementById("counter").innerHTML=counter;    
    }
   
   
   var connection;
   var cbutton = document.getElementById('connectButton');
    cbutton.addEventListener("click", function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }
      Puck.connect(function(c) {
        if (!c) {
          alert("Couldn't connect!");
          return;
        }
        connection = c;
        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var i = buf.indexOf("\n");
          while (i>=0) {
            onLine(buf.substr(0,i));
            buf = buf.substr(i+1);
            i = buf.indexOf("\n");
          }
        });
       
        // First, reset Puck.js
        connection.write("reset();\n", function() {
          // Wait for it to reset itself
          setTimeout(function() {
            // Now tell it to write data on the current light level to Bluetooth
            // 10 times a second. Also ensure that when disconnected, Puck.js
            // resets so the setInterval doesn't keep draining battery.
            connection.write("var c = E.compiledC(`
// void encA(bool)
// void encB(bool)
// int getEnc()
const int stable[] = {0,-1,1,0,1,0,0,-1,-1,0, 0,1, 0,1, -1, 0};
volatile bool encoder_raw[] = {false, false};
volatile int counter = 0;
volatile int prev_state = -1;
void encoder_callback(int AB, bool value){
    encoder_raw[AB]=value;
    int cur_state = encoder_raw[0] << 1 | encoder_raw[1];
    if(prev_state < 0) prev_state = cur_state;
    counter += stable[prev_state << 2 | cur_state];
    prev_state=cur_state;
};
void encA(bool state){ encoder_callback(0,state); }
void encB(bool state){ encoder_callback(1,state); }
int getEnc() {
 int r = counter;
 return r;
}
`);
setWatch(c.encA, D25, {repeat:true, edge:"both", irq:true});
setWatch(c.encB, D26, {repeat:true, edge:"both", irq:true});
setTimeout(function(){
// Every .1 seconds, report back the value
setInterval(function() {
  Bluetooth.println(c.getEnc());
  //print(c.getEnc());
}, 10);
},2000);NRF.on('disconnect', function() {reset()});\n",
              function() { console.log("Ready..."); });
          }, 1500);
        });
        
        
      });
    });
   
   
  </script>
 </body>
</html>
